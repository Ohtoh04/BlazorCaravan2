@page "/caravan/{SessionId}"

@using System.Collections.Generic
@using BlazorCaravan2.Client.Services
@using CaravanDomain.Models;
@using CaravanDomain.Entities;
@using Microsoft.AspNetCore.SignalR.Client;

@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager Navigation



@code {
    [Parameter]
    public string SessionId { get; set; } = string.Empty;

    int maxHandCards = 8;
    int maxCaravanCards = 10;

    // Данные для карт

    private GameState? _gameState { get; set; }
    protected HubConnection? HubConnection;
    protected string[] PlayerIds = new string[2];

    protected bool IsConnected = false;
    protected string Message = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity != null && user.Identity.IsAuthenticated)
        {
            PlayerIds[0] = user.FindFirst("sub")?.Value ?? user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
        }

        HubConnection = new HubConnectionBuilder()
           .WithUrl("/caravanhub")
           .Build();

        HubConnection.On<GameState>("CardPlayed", (receivedGameState) =>
        {
            _gameState = receivedGameState;
            StateHasChanged();
        });
        HubConnection.On<string, GameState>("GameStarted", (sessionId, receivedGameState) =>
        {
            SessionId = sessionId;
            _gameState = receivedGameState;
            StateHasChanged();
        });
        HubConnection.On<GameState>("CardDrawn", (receivedGameState) =>
        {
            _gameState = receivedGameState;

            StateHasChanged();
        });
        HubConnection.On<GameState>("TurnEnded", (receivedGameState) =>
        {
            _gameState = receivedGameState;
            StateHasChanged();
        });
        HubConnection.On<string>("PlayerJoined", (playerId) =>
        {
            PlayerIds[1] = playerId;
            StateHasChanged();
        });
        HubConnection.On<string>("GameOver", (winner) =>
        {
            // winner is a player id
            StateHasChanged();
        });


        await HubConnection.StartAsync();
        IsConnected = true;

        // Присоединение к игре
        await HubConnection.InvokeAsync("JoinGame", SessionId, PlayerIds[0]);
        Message = "Waiting for another player to join...";
        StateHasChanged();
    }

    public async Task PlayCard(string card, int caravanIndex)
    {
        if (HubConnection != null)
        {
            await HubConnection.InvokeAsync("PlayCard", SessionId, PlayerIds[0], card, caravanIndex);
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (HubConnection != null)
        {
            await HubConnection.DisposeAsync();
        }
    }

    void OnDragStart(string card, DragEventArgs e)
    {
        //e.DataTransfer.SetData("text/plain", card);
    }

    async Task OnDrop(int caravanIndex, DragEventArgs e)
    {
        // var card = e.DataTransfer.GetData("text/plain");
        // if (!string.IsNullOrEmpty(card))
        // {
        //     await PlayCard(card, caravanIndex);
        // }
    }
}

<div class="container mt-4">
    <div class="row">
        <!-- Карты на руке Игрока 1 -->
        <div class="col-md-2 hand-cards">
            <h4>Ваши карты</h4>
            @foreach (var card in _gameState.YourHand)
            {
                <div class="card" draggable="true" @ondragstart="e => OnDragStart(card.ToString(), e)">
                    @card
                </div>
            }
        </div>

        <!-- Центральные караваны -->
        <div class="col-md-8">
            <div class="row">
                <!-- Первый караван (врага) -->
                <div class="col-md-4 card-stack enemy-stack">
                    <h5 class="text-center">Караван 1 (Враг)</h5>
                    @foreach (var card in _gameState.OpponentCaravans[0].Cards)
                    {
                        <div class="card">@card</div>
                    }
                </div>

                <!-- Второй караван (врага) -->
                <div class="col-md-4 card-stack enemy-stack">
                    <h5 class="text-center">Караван 2 (Враг)</h5>
                    @foreach (var card in _gameState.OpponentCaravans[1].Cards)
                    {
                        <div class="card">@card</div>
                    }
                </div>

                <!-- Третий караван (врага) -->
                <div class="col-md-4 card-stack enemy-stack">
                    <h5 class="text-center">Караван 3 (Враг)</h5>
                    @foreach (var card in _gameState.OpponentCaravans[2].Cards)
                    {
                        <div class="card">@card</div>
                    }
                </div>
            </div>

            <div class="row mt-4">
                <!-- Первый караван (игрока) -->
                <div class="col-md-4 card-stack" @ondrop="e => OnDrop(0, e)">
                    <h5 class="text-center">Караван 1 (Вы)</h5>
                    @foreach (var card in _gameState.YourCaravans[0].Cards)
                    {
                        <div class="card">@card</div>
                    }
                </div>

                <!-- Второй караван (игрока) -->
                <div class="col-md-4 card-stack" @ondrop="e => OnDrop(1, e)">
                    <h5 class="text-center">Караван 2 (Вы)</h5>
                    @foreach (var card in _gameState.YourCaravans[1].Cards)
                    {
                        <div class="card">@card</div>
                    }
                </div>

                <!-- Третий караван (игрока) -->
                <div class="col-md-4 card-stack" @ondrop="e => OnDrop(2, e)">
                    <h5 class="text-center">Караван 3 (Вы)</h5>
                    @foreach (var card in _gameState.YourCaravans[2].Cards)
                    {
                        <div class="card">@card</div>
                    }
                </div>
            </div>
        </div>

        <!-- Карты на руке Игрока 2 -->
@*         <div class="col-md-2 hand-cards">
            <h4>Карты противника</h4>
            @foreach (var card in _gameState.YourHand.Cards)
            {
                <div class="card">
                    @card
                </div>
            }
        </div> *@
    </div>
</div>